<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Scolaire - Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            display: flex; /* Active le mode Flexbox (Côte à côte) */
            overflow: hidden;
        }

        /* --- 1. SIDEBAR (GAUCHE) --- */
        .sidebar {
            width: 400px; /* Largeur fixe */
            height: 100vh;
            background: white;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 1000; /* Au-dessus de la carte si besoin */
            border-right: 1px solid #eee;
        }

        .sidebar-header {
            padding: 25px 25px 0 25px;
        }

        .scrollable-content {
            padding: 25px;
            overflow-y: auto; /* Permet de scroller si la liste est longue */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 25px; /* Espace entre les composants */
        }

        /* --- COMPOSANT 1 : TRACKER (Nouveau UI) --- */
        .tracker-card {
            background: linear-gradient(145deg, #ffffff, #f0f2f5);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
            border: 1px solid #fff;
        }

        .tracker-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-box {
            background: white;
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            border: 1px solid #eee;
        }

        .info-label { font-size: 0.7em; color: #888; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; }
        .info-value { font-size: 1.1em; font-weight: 700; color: #2c3e50; }

        .destination-box {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            text-align: center;
        }

        /* --- COMPOSANT 2 : GESTION FAMILLES --- */
        .manager-card {
            background: white;
        }

        .form-control:focus {
            box-shadow: none;
            border-color: #6a11cb;
        }

        .family-item {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .family-item:hover { transform: translateX(5px); border-color: #ddd; }

        .status-ok { border-left: 4px solid #198754; }
        .status-warn { border-left: 4px solid #dc3545; }

        /* --- 2. MAP (DROITE) --- */
        .map-wrapper {
            flex-grow: 1; /* Prend tout le reste de l'espace */
            position: relative;
        }
        #map { height: 100%; width: 100%; }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h4 class="fw-bold" style="color:#2c3e50;"><i class="fas fa-school me-2 text-warning"></i>Transport App</h4>
    </div>

    <div class="scrollable-content">

        <div class="tracker-card">
            <div class="d-flex justify-content-between align-items-center">

                <span id="busStatus" class="badge bg-secondary rounded-pill">--</span>
            </div>

            <div class="destination-box">
                <small class="d-block text-uppercase" style="opacity:0.7; font-size:0.7em;">Prochaine Station</small>
                <div id="busDest" class="fw-bold fs-5 text-truncate">--</div>
            </div>

            <div class="tracker-info-grid">
                <div class="info-box">
                    <div class="info-label"><i class="fas fa-road me-1"></i>Dist.</div>
                    <div id="busDist" class="info-value">--</div>
                </div>
                <div class="info-box">
                    <div id="timeLabel" class="info-label"><i class="fas fa-clock me-1"></i>ETA</div>
                    <div id="busTime" class="info-value text-primary">--</div>
                </div>
            </div>
        </div>

        <div class="manager-card">
            <h6 class="fw-bold mb-3 border-bottom pb-2"><i class="fas fa-users-cog me-2"></i>Familles</h6>

            <div class="mb-3 p-3 bg-light rounded-3">
                <div class="mb-2">
                    <input type="text" id="nomParent" class="form-control form-control-sm mb-2" placeholder="Nom de la famille">
                    <div class="input-group input-group-sm">
                        <input type="number" id="latParent" class="form-control" placeholder="Lat">
                        <input type="number" id="lonParent" class="form-control" placeholder="Lon">
                    </div>
                </div>
                <button onclick="ajouterParent()" class="btn btn-dark btn-sm w-100 fw-bold">Ajouter</button>
                <small class="text-muted d-block text-center mt-1" style="font-size:0.7em">Cliquer sur la carte pour GPS</small>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small fw-bold text-muted">LISTE DES STATIONS</span>
                <span id="totalCount" class="badge bg-light text-dark border">0</span>
            </div>

            <div id="listeParents">
            </div>
        </div>

    </div>
</div>

<div class="map-wrapper">
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Initialisation Carte
    var map = L.map('map', { zoomControl: false }).setView([33.9981, -6.7943], 14);
    L.control.zoom({ position: 'topright' }).addTo(map); // Zoom à droite pour pas gêner

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

    // Icones
    var busIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [50, 50], iconAnchor: [25, 25] });
    var schoolIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/167/167707.png', iconSize: [45, 45], iconAnchor: [22, 45], popupAnchor: [0, -40] });
    var houseIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/1040/1040993.png', iconSize: [35, 35], iconAnchor: [17, 35], popupAnchor: [0, -35] });

    // Marqueurs
    var schoolMarker = L.marker([33.9981, -6.7943], {icon: schoolIcon}).addTo(map).bindPopup("<b>École EMI</b>");
    var busMarker = L.marker([33.9981, -6.7943], {icon: busIcon}).addTo(map);
    var parentsMarkers = [];

    // 2. Mise à jour Bus + CALCUL DU TEMPS RESTANT (ETA)
    function updateBus() {
        fetch('/api/bus/live')
            .then(response => response.json())
            .then(data => {
                // Positionnement
                var newLatLng = [data.latitude, data.longitude];
                busMarker.setLatLng(newLatLng);
                map.panTo(newLatLng);

                // Mise à jour Textes
                document.getElementById('busDest').innerText = data.destination;
                document.getElementById('busDist').innerText = data.distanceRestante;

                var timeLabel = document.getElementById('timeLabel');
                var timeValue = document.getElementById('busTime');

                // --- LOGIQUE CALCUL TEMPS (ETA) ---
                if (data.status === 'MOVING') {
                    // Le bus roule : On calcule l'ETA
                    timeLabel.innerHTML = '<i class="fas fa-hourglass-half me-1"></i>ETA';

                    // "1.2 km" -> 1.2
                    let distStr = data.distanceRestante.replace(' km', '').replace(',', '.');
                    let dist = parseFloat(distStr);

                    if(!isNaN(dist)) {
                        // Supposons une vitesse moyenne de 30 km/h en ville
                        // Temps (min) = (Distance (km) / 30) * 60 = Distance * 2
                        let etaMinutes = Math.ceil(dist * 2);
                        if(etaMinutes < 1) etaMinutes = 1;
                        timeValue.innerText = "~ " + etaMinutes + " min";
                    } else {
                        timeValue.innerText = "Calcul...";
                    }

                    document.getElementById('busStatus').className = 'badge bg-success rounded-pill';
                    document.getElementById('busStatus').innerText = 'EN ROUTE';

                } else {
                    // Le bus est à l'arrêt : On affiche le temps d'arrêt réel (donné par le serveur)
                    timeLabel.innerHTML = '<i class="fas fa-stopwatch me-1"></i>ARRÊT';
                    timeValue.innerText = data.tempsRestant; // ex: "4 min"

                    document.getElementById('busStatus').className = 'badge bg-danger rounded-pill';
                    document.getElementById('busStatus').innerText = 'STOPPED';
                }
            });
    }

    // 3. Gestion Parents
    function updateParentsList() {
        fetch('/api/bus/parents')
            .then(response => response.json())
            .then(parents => {
                var container = document.getElementById('listeParents');
                document.getElementById('totalCount').innerText = parents.length;
                container.innerHTML = '';

                parentsMarkers.forEach(m => map.removeLayer(m));
                parentsMarkers = [];

                parents.forEach(p => {
                    var m = L.marker([p.latitude, p.longitude], {icon: houseIcon}).bindPopup(p.nom).addTo(map);
                    parentsMarkers.push(m);

                    var hasPenalty = p.nombrePenalites > 0;
                    var statusClass = hasPenalty ? 'status-warn' : 'status-ok';
                    var badgeHtml = hasPenalty
                        ? `<span class="badge bg-danger text-white rounded-pill">${p.nombrePenalites} <i class="fas fa-exclamation-triangle ms-1"></i></span>`
                        : `<span class="badge bg-light text-secondary border rounded-pill"><i class="fas fa-check"></i></span>`;

                    var html = `
                        <div class="family-item ${statusClass}">
                            <div class="d-flex align-items-center">
                                <div class="fw-bold text-dark small me-2">${p.nom}</div>
                            </div>
                            <div class="d-flex align-items-center">
                                ${badgeHtml}
                                <button onclick="supprimerParent(${p.id})" class="btn btn-link text-secondary p-0 ms-2"><i class="fas fa-trash-alt small"></i></button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            });
    }

    // Fonctions Actions
    function ajouterParent() {
        var nom = document.getElementById('nomParent').value;
        var lat = document.getElementById('latParent').value;
        var lon = document.getElementById('lonParent').value;
        if(!nom || !lat) return;
        fetch('/api/bus/parents', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nom: nom, latitude: lat, longitude: lon })
        }).then(() => { updateParentsList(); document.getElementById('nomParent').value=''; });
    }

    function supprimerParent(id) {
        if(confirm("Supprimer ?")) fetch('/api/bus/parents/' + id, { method: 'DELETE' }).then(() => updateParentsList());
    }

    map.on('click', function(e) {
        document.getElementById('latParent').value = e.latlng.lat.toFixed(4);
        document.getElementById('lonParent').value = e.latlng.lng.toFixed(4);
    });

    // Loops
    setInterval(updateBus, 1000);
    setInterval(updateParentsList, 2000);
    updateParentsList();
</script>
</body>
</html>